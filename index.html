<!DOCTYPE html>


<!--
"GRO" is a musical composition for web browsers.
-->


<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GRO">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-starturl" content="/">

    <link rel="apple-touch-icon" sizes="180x180" href="fav/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="fav/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="192x192" href="fav/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="16x16" href="fav/favicon-16x16.png">
    <link rel="manifest" href="manifest.json">
    <link rel="mask-icon" href="fav/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="theme-color" content="#CCBBAA">

    <title>GRO</title>
    <meta name="description" content="Musical Composition For Web Browsers">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta property="og:title" content="GRO" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://badfrienddigital.github.io/gro" />
    <meta property="og:image" content="https://badfrienddigital.github.io/gro/fav/android-chrome-256x256.png" />

</head>

<style>

/*
BEGIN Tachyons.io CSS (Cross-Browser Normalization)
*/

/**
* 1. Correct the text wrapping in Edge and IE.
* 2. Correct the color inheritance from `fieldset` elements in IE.
* 3. Remove the padding so developers are not caught out when they zero out
*    `fieldset` elements in all browsers.
*/

legend {
    -webkit-box-sizing: border-box;
            box-sizing: border-box;
    /* 1 */
    color: inherit;
    /* 2 */
    display: table;
    /* 1 */
    max-width: 100%;
    /* 1 */
    padding: 0;
    /* 3 */
    white-space: normal;
    /* 1 */
}
/**
* Remove the default vertical scrollbar in IE.
*/

textarea {
    overflow: auto;
}
/**
* 1. Add the correct box sizing in IE 10-.
* 2. Remove the padding in IE 10-.
*/

[type='checkbox'], [type='radio'] {
    -webkit-box-sizing: border-box;
            box-sizing: border-box;
    /* 1 */
    padding: 0;
    /* 2 */
}
/**
* Correct the cursor style of increment and decrement buttons in Chrome.
*/

[type='number']::-webkit-inner-spin-button, [type='number']::-webkit-outer-spin-button {
    height: auto;
}
/**
* 1. Correct the odd appearance in Chrome and Safari.
* 2. Correct the outline style in Safari.
*/

[type='search'] {
    -webkit-appearance: textfield;
    /* 1 */
    outline-offset: -2px;
    /* 2 */
}
/**
* Remove the inner padding and cancel buttons in Chrome and Safari on OS X.
*/

[type='search']::-webkit-search-cancel-button, [type='search']::-webkit-search-decoration {
    -webkit-appearance: none;
}
/**
* Correct the text style of placeholders in Chrome, Edge, and Safari.
*/

::-webkit-input-placeholder {
    color: inherit;
    opacity: 0.54;
}
/**
* 1. Correct the inability to style clickable types in iOS and Safari.
* 2. Change font properties to `inherit` in Safari.
*/

::-webkit-file-upload-button {
    -webkit-appearance: button;
    /* 1 */
    font: inherit;
    /* 2 */
}
/**
* Show the overflow in IE.
* 1. Show the overflow in Edge.
*/

button, input {
    /* 1 */
    overflow: visible;
}
/**
* Remove the inheritance of text transform in Edge, Firefox, and IE.
* 1. Remove the inheritance of text transform in Firefox.
*/

button, select {
    /* 1 */
    text-transform: none;
}
/**
* 1. Prevent a WebKit bug where (2) destroys native `audio` and `video`
*    controls in Android 4.
* 2. Correct the inability to style clickable types in iOS and Safari.
*/

button, html [type='button'], /* 1 */

[type='reset'], [type='submit'] {
    -webkit-appearance: button;
    /* 2 */
}
/**
* Remove the inner border and padding in Firefox.
*/

button::-moz-focus-inner, [type='button']::-moz-focus-inner, [type='reset']::-moz-focus-inner, [type='submit']::-moz-focus-inner {
    border-style: none;
    padding: 0;
}
/**
* Restore the focus styles unset by the previous rule.
*/

button:-moz-focusring, [type='button']:-moz-focusring, [type='reset']:-moz-focusring, [type='submit']:-moz-focusring {
    outline: 1px dotted ButtonText;
}
/**
* 1. Remove the bottom border in Firefox 39-.
* 2. Add the correct text decoration in Chrome, Edge, IE, Opera, and Safari.
*/

abbr[title] {
    border-bottom: none;
    /* 1 */
    text-decoration: underline;
    /* 2 */
    text-decoration: underline dotted;
    /* 2 */
}
/**
* Prevent the duplicate application of `bolder` by the next rule in Safari 6.
*/

b, strong {
    font-weight: inherit;
}
/**
* Add the correct font weight in Chrome, Edge, and Safari.
*/

b, strong {
    font-weight: bolder;
}
/**
* Add the correct font style in Android 4.3-.
*/

dfn {
    font-style: italic;
}
/**
* Correct the font size and margin on `h1` elements within `section` and
* `article` contexts in Chrome, Firefox, and Safari.
*/
/*
h1 {
font-size: 2em;
margin: 0.67em 0;
}
*/
/**
* Add the correct background and color in IE 9-.
*/

mark {
    background-color: #FFFF00;
    color: #000000;
}
/**
* Add the correct font size in all browsers.
*/

small {
    font-size: 80%;
}
/**
* Prevent `sub` and `sup` elements from affecting the line height in
* all browsers.
*/

sub, sup {
    font-size: 75%;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
}

sub {
    bottom: -0.25em;
}

sup {
    top: -0.5em;
}
/* Embedded content
========================================================================== */
/**
* Remove the border on images inside links in IE 10-.
*/

img {
    border-style: none;
}
/**
* Hide the overflow in IE.
*/

svg:not(:root) {
    overflow: hidden;
}
/* Grouping content
========================================================================== */
/**
* 1. Correct the inheritance and scaling of font size in all browsers.
* 2. Correct the odd `em` font sizing in all browsers.
*/

code, kbd, pre, samp {
    font-family: monospace, monospace;
    /* 1 */
    font-size: 1em;
    /* 2 */
}
/**
* Add the correct margin in IE 8.
*/

figure {
    margin: 1em 40px;
}
/**
* 1. Add the correct box sizing in Firefox.
* 2. Show the overflow in Edge and IE.
*/

hr {
    -webkit-box-sizing: content-box;
            box-sizing: content-box;
    /* 1 */
    height: 0;
    /* 1 */
    overflow: visible;
    /* 2 */
}
/* Forms
========================================================================== */
/**
* 1. Change font properties to `inherit` in all browsers (opinionated).
* 2. Remove the margin in Firefox and Safari.
*/

button, input, optgroup, select, textarea {
    font: inherit;
    /* 1 */
    margin: 0;
    /* 2 */
}
/**
* Restore the font weight unset by the previous rule.
*/

optgroup {
    font-weight: bold;
}
/**
* 1. Change the default font family in all browsers (opinionated).
* 2. Correct the line height in all browsers.
* 3. Prevent adjustments of font size after orientation changes in IE and iOS.
*/

html {
    font-family: sans-serif;
    /* 1 */
    line-height: 1.15;
    /* 2 */
        -ms-text-size-adjust: 100%;
    /* 3 */
    -webkit-text-size-adjust: 100%;
    /* 3 */
}
/**
* Remove the margin in all browsers (opinionated).
*/

body {
    margin: 0;
}
/* HTML5 display definitions
========================================================================== */
/**
* Add the correct display in IE 9-.
* 1. Add the correct display in Edge, IE, and Firefox.
* 2. Add the correct display in IE.
*/

article, aside, details, /* 1 */

figcaption, figure, footer, header, main, /* 2 */

menu, nav, section, summary {
    /* 1 */
    display: block;
}
/**
* Add the correct display in IE 9-.
*/

audio, canvas, progress, video {
    display: inline-block;
}
/**
* Add the correct display in iOS 4-7.
*/

audio:not([controls]) {
    display: none;
    height: 0;
}
/**
* Add the correct vertical alignment in Chrome, Firefox, and Opera.
*/

progress {
    vertical-align: baseline;
}
/**
* Add the correct display in IE 10-.
* 1. Add the correct display in IE.
*/

template, /* 1 */

[hidden] {
    display: none;
}
/* Links
========================================================================== */
/**
* 1. Remove the gray background on active links in IE 10.
* 2. Remove gaps in links underline in iOS 8+ and Safari 8+.
*/

a {
    background-color: transparent;
    /* 1 */
    -webkit-text-decoration-skip: objects;
    /* 2 */
}
/**
* Remove the outline on focused links when they are also active or hovered
* in all browsers (opinionated).
*/

a:active, a:hover {
    outline-width: 0;
}

/*
END Tachyons.io CSS
*/

html {
    font-size: 18px;
    overflow: hidden;
}

@media (max-width: 900px) {
    html {
        font-size: 20px;
    }
}
@media (max-width: 400px) {
    html {
        font-size: 18px;
    }
}

body {
    overflow: hidden;
    background: #BB6633;
    font-family: -apple-system, BlinkMacSystemFont,
    'avenir next', avenir,
    'helvetica neue', helvetica,
    ubuntu,
    roboto, noto,
    'segoe ui', arial,
    sans-serif;
    width: 100vw;
    height: 100vh;
    position: absolute;
}

/*
animation durations & delays are modified in the javascript
to sync with BPM of music
*/


/**
* "sure" is the background div; a square divided into four
*/

.sure {
    border-bottom: 150vh solid #664433;
    border-left: 150vw solid #BB6633;
    border-right: 150vw solid #CCBBAA;
    border-top: 150vh solid #997777;
    position: absolute;
    -webkit-transform: rotate(50deg);
            transform: rotate(50deg);
    left: -100vw;
    top: -100vh;
    opacity: 0.75;
    overflow: hidden;
    -webkit-animation-name: rotator;
            animation-name: rotator;
    -webkit-animation-fill-mode: forwards;
            animation-fill-mode: forwards;
    -webkit-animation-timing-function: ease;
            animation-timing-function: ease;
    -webkit-animation-duration: 1.714s;
            animation-duration: 1.714s;
}

/**
* "top" is the horizontal bar div;
*/

.top {
    display: block;
    position: absolute;
    width: 100vw;
    height: 45vh;
    top: 15vh;
    left: 0;
    background-color: #332211;
    overflow: hidden;

}

/**
* "low" is the circular div;
*/

.low {
    display: block;
    position: absolute;
    border-radius: 100%;
    width: 65vw;
    height: 65vw;
    top: 65vh;
    left: 55vw;
    background-color: #997777;
    overflow: hidden;

}

@-webkit-keyframes rotator {
    0%, 100% {
        -webkit-transform: rotate(50deg);
                transform: rotate(50deg);
    }
    25% {
        -webkit-transform: rotate(95deg);
                transform: rotate(95deg);
    }
}

@keyframes rotator {
    0%, 100% {
        -webkit-transform: rotate(50deg);
                transform: rotate(50deg);
    }
    25% {
        -webkit-transform: rotate(95deg);
                transform: rotate(95deg);
    }
}


@-webkit-keyframes upper {
  0%, 50%, 100% {
      -webkit-transform: translateY(0ex);
              transform: translateY(0ex);
  }
  25% {
      -webkit-transform: translateY(-0.2ex);
              transform: translateY(-0.2ex);
  }
  75% {
      -webkit-transform: translateY(0.2ex);
              transform: translateY(0.2ex);
  }
}

@keyframes upper {
    0%, 50%, 100% {
        -webkit-transform: translateY(0ex);
                transform: translateY(0ex);
    }
    25% {
        -webkit-transform: translateY(-0.2ex);
                transform: translateY(-0.2ex);
    }
    75% {
        -webkit-transform: translateY(0.2ex);
                transform: translateY(0.2ex);
    }
}

@-webkit-keyframes downer {
    0%, 50%, 100% {
        -webkit-transform: translateY(0ex);
                transform: translateY(0ex);
    }
    25% {
        -webkit-transform: translateY(0.2ex);
                transform: translateY(0.2ex);
    }
    75% {
        -webkit-transform: translateY(-0.2ex);
                transform: translateY(-0.2ex);
    }
}

@keyframes downer {
    0%, 50%, 100% {
        -webkit-transform: translateY(0ex);
                transform: translateY(0ex);
    }
    25% {
        -webkit-transform: translateY(0.2ex);
                transform: translateY(0.2ex);

    }
    75% {
        -webkit-transform: translateY(-0.2ex);
                transform: translateY(-0.2ex);
    }
}

@-webkit-keyframes buttonIn {
    0% {
        opacity: 0;
    }
    100% {
        opacity: 1;
    }
}

@keyframes buttonIn {
    0% {
        opacity: 0;
    }
    100% {
        opacity: 1;
    }
}

.button {
    position: absolute;
    left: calc(50vw - (1.8rem + 4ex)/2);
    top: calc(50vh - (1.8rem + 2ex)/2);
    display: block;
    padding: 0.9rem;
    font-size: 2.5rem;
    cursor: pointer;
    font-weight: bold;
    text-align: center;
    text-decoration: none;
    outline: none;
    color: #CCBBAA;
    background-color: #332211;
    border: none;
    border-radius: 100%;
            user-select: none;
       -moz-user-select: none;
        -ms-user-select: none;
    -webkit-user-select: none;
    -webkit-tap-highlight-color: rgba(0,0,0,0);
    opacity: 0;
    -webkit-animation-name: buttonIn;
            animation-name: buttonIn;
    -webkit-animation-fill-mode: forwards;
            animation-fill-mode: forwards;
    -webkit-animation-timing-function: ease;
            animation-timing-function: ease;
    -webkit-animation-duration: 0.75s;
            animation-duration: 0.75s;
            animation-play-state: paused;
    -webkit-animation-play-state: paused;
}

.button:hover {
    font-size: 2.6rem;
    background-color: #4F3826;
}

.button:active {
    font-size: 2.8rem;
    font-weight: 800;
    unicode-bidi: bidi-override;
    direction: rtl;
    color: #332211;
    background-color: #BFAA9D;
}

/**
* "loader" is the text that says "loading";
*/

.loader {
    position: absolute;
    left: calc(50vw - (1.8rem + 4ex)/2);
    top: calc(50vh - (1.8rem + 4.5ex)/2);
    display: block;
    color: #332211;
    font-size: 2rem;
    font-weight: bold;
    text-align: center;
    text-decoration: none;
    outline: none;
    -webkit-transform: translateZ(0);
            transform: translateZ(0);
}

/**
* "upper" and "lower" control the animation of the "loading" letters;
*  durations modified in javascript to sync with tempo
*/

.upper {
    -webkit-animation-name: upper;
            animation-name: upper;
    -webkit-animation-iteration-count: infinite;
            animation-iteration-count: infinite;
    display: inline-block;
    -webkit-animation-fill-mode: forwards;
            animation-fill-mode: forwards;
    -webkit-animation-timing-function: ease-in;
            animation-timing-function: ease-in;
    -webkit-animation-duration: 5s;
            animation-duration: 5s;
}

.downer {
    -webkit-animation-name: downer;
            animation-name: downer;
    -webkit-animation-iteration-count: infinite;
            animation-iteration-count: infinite;
    display: inline-block;
    -webkit-animation-fill-mode: forwards;
            animation-fill-mode: forwards;
    -webkit-animation-timing-function: ease-out;
            animation-timing-function: ease-out;
    -webkit-animation-duration: 5s;
            animation-duration: 5s;
}

</style>

<body>
  <div class="top" id="top"></div>
  <div class="low" id="low"></div>
  <div class="sure" id="sure"></div>
  <p aria-label="loading" alt="loading" class="loader" id="loader"><span class="downer" id="x4">l</span><span class="upper" id="x3">oa</span><span class="downer" id="x2b">d</span><span class="upper" id="x2a">i</span><span class="downer" id="x1">ng</span></p>
  <input aria-hidden="true" class="button" id="beginner" type="button" value="ORG" onclick="playIt()" />

<script src="stereo-panner-node.min.js"></script>

<script>
// CSS animation elements

var bDiv = document.getElementById("sure");
var buttr = document.getElementById("beginner");
var loader = document.getElementById("loader");
var bodd = loader.parentNode;

// disable playback button until audio is ready

buttr.onclick = "";
buttr.style.cursor = "auto";


// create audio context and apply latency hint, if possible

if (!window.hasOwnProperty("AudioContext") && window.hasOwnProperty("webkitAudioContext")){
	window.AudioContext = window.webkitAudioContext;
  }

var audioContext =  new AudioContext();
if("latencyHint" in audioContext) {
  audioContext.latencyHint = "playback";
  }

var context = audioContext;


// Mohoyanao's StereoPanner poly

StereoPannerNode.polyfill();


// create audio processing nodes

var masterGain = audioContext.createGain();

var volume1 = audioContext.createGain();
var volume2 = audioContext.createGain();
var volume3 = audioContext.createGain();
var volume4 = audioContext.createGain();
var volume5 = audioContext.createGain();


// one of the audio loops gets doubled and tuned an octave up
// however, if this method is not available
// the corresponding audio nodes are not created

if("detune" in AudioBufferSourceNode) {
  var volume5Up = audioContext.createGain();
  var volume5UpPre = audioContext.createGain();
  }

var panner2 = audioContext.createStereoPanner();
var panner3 = audioContext.createStereoPanner();
var panner4 = audioContext.createStereoPanner();
var panner5 = audioContext.createStereoPanner();
if("detune" in AudioBufferSourceNode) {
  var panner5Up = audioContext.createStereoPanner();
  }

panner2.pan.value = 0.35;
panner3.pan.value = -0.35;
panner4.pan.value = 0.75;
panner5.pan.value = -0.75;
if("detune" in AudioBufferSourceNode) {
  panner5Up.pan.value = 0.85;
  }

var filter1 = audioContext.createBiquadFilter();
var filter2 = audioContext.createBiquadFilter();
var filter3 = audioContext.createBiquadFilter();
var filter4 = audioContext.createBiquadFilter();
var filter5 = audioContext.createBiquadFilter();
if("detune" in AudioBufferSourceNode) {
  var filter5Up = audioContext.createBiquadFilter();
  }

filter1.type = "lowpass";
filter1.frequency.value = 1200;

filter2.type = "lowpass";
filter2.frequency.value = 1450;

filter3.type = "highpass";
filter3.frequency.value = 300;

filter4.type = "highpass";
filter4.frequency.value = 350;

filter5.type = "highpass";
filter5.frequency.value = 450;

if("detune" in AudioBufferSourceNode) {
  filter5Up.type = "lowpass";
  filter5Up.frequency.value = 3500;
  }


// create LFOs

var LFO1 = audioContext.createOscillator();
var LFO2 = audioContext.createOscillator();

LFO1.type = 'triangle';
LFO2.type = 'sine';


// use gain nodes to vary the amount of LFO applied

var LFOgain1 = audioContext.createGain();
var LFOgain2 = audioContext.createGain();
var LFOgain3 = audioContext.createGain();
var LFOgain4 = audioContext.createGain();
var LFOgain5 = audioContext.createGain();

LFOgain1.gain.value = 0.3;
LFOgain2.gain.value = 0.15;
LFOgain3.gain.value = 0.2;
LFOgain4.gain.value = 0.4;
LFOgain5.gain.value = 0.3;

LFO1.connect(LFOgain1);
LFO1.connect(LFOgain2);
LFO1.connect(LFOgain4);

LFO2.connect(LFOgain3);
LFO2.connect(LFOgain5);


// apply LFOs to the loop volumes

LFOgain1.connect(volume1.gain);
LFOgain2.connect(volume2.gain);
LFOgain3.connect(volume3.gain);
LFOgain4.connect(volume4.gain);
LFOgain5.connect(volume5.gain);
if("detune" in AudioBufferSourceNode) {
  LFOgain5.connect(volume5Up.gain);
  }

// create AudioBufferSourceNodes to play the audio loops

var organ1 = audioContext.createBufferSource();
var organ2 = audioContext.createBufferSource();
var organ3 = audioContext.createBufferSource();
var organ4 = audioContext.createBufferSource();
var organ5 = audioContext.createBufferSource();
if("detune" in AudioBufferSourceNode) {
  var organ5Up = audioContext.createBufferSource();
  }

//
// provide both 41k and 48k samplerate files;
// serve based on device's samplerate

var lowOrg = 'audio/organ-low-2m-48-b.mp4';
var medOrg = 'audio/organ-med-8m-48.mp4';
var hiOrg = 'audio/organ-hi-7m-48.mp4';
var hierOrg = 'audio/organ-hi-er-9m-48.mp4';
var hiestOrg = 'audio/organ-hi-est-6m-48.mp4';

 if (audioContext.sampleRate === 44100) {
   lowOrg = 'audio/organ-low-2m-b.mp4';
   medOrg = 'audio/organ-med-8m.mp4';
   hiOrg = 'audio/organ-hi-7m.mp4';
   hierOrg = 'audio/organ-hi-er-9m.mp4';
   hiestOrg = 'audio/organ-hi-est-6m.mp4';
 }

// fetch samples

getSample(lowOrg, function play(buffer) {
  // save buffer in global var for later use
  temp1 = buffer;

  // connect sourceNode to the buffer & to audio processing
  organ1.buffer = temp1;
  organ1.connect(filter1);
  filter1.connect(volume1);
  volume1.connect(masterGain);
  organ1.loop = true;
  volume1.gain.value = 0.8;

});

getSample(medOrg, function play(buffer) {
  temp2 = buffer;
  organ2.buffer = temp2;
  organ2.connect(filter2);
  filter2.connect(volume2);
  volume2.connect(panner2);
  panner2.connect(masterGain);
  organ2.loop = true;
  volume2.gain.value = 0.84;

});

getSample(hiOrg, function play(buffer) {
  temp3 = buffer;
  organ3.buffer = temp3;
  organ3.connect(filter3);
  filter3.connect(volume3);
  volume3.connect(panner3);
  panner3.connect(masterGain);
  organ3.loop = true;
  volume3.gain.value = 0.78;

});

getSample(hierOrg, function play(buffer) {
  temp4 = buffer;
  organ4.buffer = temp4;
  organ4.connect(filter4);
  filter4.connect(volume4);
  volume4.connect(panner4);
  panner4.connect(masterGain);
  organ4.loop = true;
  volume4.gain.value = 0.72;
});

getSample(hiestOrg, function play(buffer) {
  temp5 = buffer;
  organ5.buffer = temp5;
  organ5.connect(filter5);
  filter5.connect(volume5);
  volume5.connect(panner5);
  panner5.connect(masterGain);
  organ5.loop = true;
  volume5.gain.value = 0.72;

// if possible,
// loop #5 is played by TWO nodes;
// the second node pitches the sample up an octave
// and only plays through the master delay effect

if("detune" in AudioBufferSourceNode) {
  organ5Up.buffer = organ5.buffer;
  organ5Up.connect(volume5UpPre);
  volume5UpPre.connect(volume5Up);
  volume5Up.connect(filter5Up);
  filter5Up.connect(panner5Up);
  panner5Up.connect(mdelay);
  organ5Up.loop = true;
  volume5UpPre.gain.value = 0.23;
  organ5Up.detune.value = 1200;
}
});

var xhrs = 0;

function getSample(url, cb) {

// if possible, use the Fetch API,
// so that a serviceWorker can cache the page

  if("fetch" in window) {
  fetch(url).then(function(response) {
  return response.arrayBuffer()
}).then(function(arrayBuffer) {
  audioContext.decodeAudioData(arrayBuffer, cb);
  xhrs++;
  // for each asset loaded, update the loader animation
  if (xhrs === 1) {
    var x1 = document.getElementById("x1");
    x1.style.color = "#CCBBAA";
  }
  if (xhrs === 2) {
    var x2a = document.getElementById("x2a");
    var x2b = document.getElementById("x2b");
    x2a.style.color = "#CCBBAA";
    x2b.style.color = "#CCBBAA";
  }
  if (xhrs === 3) {
    var x3 = document.getElementById("x3");
    x3.style.color = "#CCBBAA";
  }
  if (xhrs === 4) {
    var x4 = document.getElementById("x4");
    x4.style.color = "#CCBBAA";
  }
  if (xhrs === 5) {
    // if all files retrieved successfully,
    // enable playback button
    // pause animations
    // and remove loading animation element altogether
    buttr.style.WebkitAnimationPlayState = "running";
    buttr.style.animationPlayState = "running";
    buttr.onclick = playIt;
    buttr.style.cursor = "pointer";
    buttr.setAttribute("aria-hidden",false);
    loader.style.opacity = 0;
    loader.style.visibility = "hidden";
    loader.style.WebkitAnimationPlayState = "paused";
    loader.style.animationPlayState = "paused";
    loader.setAttribute("aria-hidden",true);
    bodd.removeChild(loader);
    }
});
}

  else {
    var request = new XMLHttpRequest();
    request.open('GET', url);
    request.responseType = 'arraybuffer';
    request.onload = function() {
      audioContext.decodeAudioData(request.response, cb);
      xhrs++;

      // for each asset loaded, update the loader animation
      if (xhrs === 1) {
        var x1 = document.getElementById("x1");
        x1.style.color = "#CCBBAA";
      }
      if (xhrs === 2) {
        var x2a = document.getElementById("x2a");
        var x2b = document.getElementById("x2b");
        x2a.style.color = "#CCBBAA";
        x2b.style.color = "#CCBBAA";
      }
      if (xhrs === 3) {
        var x3 = document.getElementById("x3");
        x3.style.color = "#CCBBAA";
      }
      if (xhrs === 4) {
        var x4 = document.getElementById("x4");
        x4.style.color = "#CCBBAA";
      }
      if (xhrs === 5) {
        // if all files retrieved successfully,
        // enable playback button
        // pause animations
        // and remove loading animation element altogether

        buttr.style.WebkitAnimationPlayState = "running";
        buttr.style.animationPlayState = "running";
        buttr.onclick = playIt;
        buttr.style.cursor = "pointer";
        buttr.setAttribute("aria-hidden",false);
        loader.style.opacity = 0;
        loader.style.visibility = "hidden";
        loader.style.WebkitAnimationPlayState = "paused";
        loader.style.animationPlayState = "paused";
        loader.setAttribute("aria-hidden",true);
        bodd.removeChild(loader);
      }
      console.log("Welcome to GRO");
    }
    request.send();
  };
}


//
// original tempo is 70 BPM
// at 70 BPM, quarter note = 857 ms
// 1 measure = 3428 ms = 3.428 s
// 6.856 s = 2m
// 10.284 s = 3m
// 13.712 s = 4m
//


// array of possible start times / start delays
// (0 = no delay)

var startTimes = [6.856, 0, 13.712, 0, 10.284];

//
// Fisher-Yates array shuffler
// https://en.wikipedia.org/wiki/Fisher%E2%80%93Yates_shuffle
//

function shuffle(array) {
  var i = 0,
    j = 0,
    temp = null;

  for (i = array.length - 1; i > 0; i -= 1) {
    j = Math.floor(Math.random() * (i + 1));
    temp = array[i];
    array[i] = array[j];
    array[j] = temp;
  }
}

shuffle(startTimes);

//
// pseudo-random number generator
// determines playback speed ("shift")
// (from 95.1% to 100.1%)
//

function getRandomArbitrary(min, max) {
  return (Math.random() * (max - min)) + min;
}

shift = getRandomArbitrary(0.951, 1.001);

//
// choose start time from shuffled array
// and apply new playback speed ("shift")
// to keep BPM internally consistent
//

rand1 = startTimes[0] / shift;
rand2 = startTimes[1] / shift;
rand3 = startTimes[2] / shift;
rand4 = startTimes[3] / shift;
rand5 = startTimes[4] / shift;

//
// initial delay ("del") to give browser extra time
// and prevent glitching
//

var del = 0.1;

var startTime1 = audioContext.currentTime + rand1 + del;
var startTime2 = audioContext.currentTime + rand2 + del;
var startTime3 = audioContext.currentTime + rand3 + del;
var startTime4 = audioContext.currentTime + rand4 + del;
var startTime5 = audioContext.currentTime + rand5 + del;

organ1.playbackRate.value = shift;
organ2.playbackRate.value = shift;
organ3.playbackRate.value = shift;
organ4.playbackRate.value = shift;
organ5.playbackRate.value = shift;
if("detune" in AudioBufferSourceNode) {
  organ5Up.playbackRate.value = shift;
  }

//
// convert original BPM into hertz
// and apply playback-rate shift;
// at 70bpm, approx 0.292hz is one measure
// 0.0208hz is approx 14 measures
// 0.0162hz is approx 18 measures
//

LFO1.frequency.value = 0.0162 * shift;
LFO2.frequency.value = 0.0208 * shift;

// IIFE to contain scope

(function(shift){

// derive animation durations from BPM
// & apply playback-rate shift;
// 3.4286s is approx 1 measure at 70 BPM
// 1.714s is approx 1/2 measure at 70 BPM

  var aniDur1 = 1.714 * shift;
  var aniDur2 = 3.4286 * shift;

  bDiv.style.WebkitAnimationDuration = aniDur1 + "s";
  bDiv.style.animationDuration = aniDur1 + "s";
  loader.style.WebkitAnimationDuration = aniDur2 + "s";
  loader.style.animationDuration = aniDur2 + "s";

}(shift));


//
// cheap, Schroeder-style Reverb, called "Freeverb"
// JS implementation by Yotam Mann in TONE.js
// https://github.com/Tonejs/Tone.js
//

// Lowpass Comb Filter

function LowpassCombFilter (context) {
  var node = context.createDelay(1);
  var output = context.createBiquadFilter();

  // this magic number seems to fix everything in Chrome 53
  // see https://github.com/livejs/freeverb/issues/1#issuecomment-249080213

  output.Q.value = -3.0102999566398125;
  output.type = 'lowpass';
  node.dampening = output.frequency;

  var feedback = context.createGain();
  node.resonance = feedback.gain;

  node.connect(output);
  output.connect(feedback);
  feedback.connect(node);

  node.dampening.value = 3000;
  node.delayTime.value = 0.1;
  node.resonance.value = 0.5;

  return node;
}

// tune the Freeverb

var srt = 44100;
var combFilterTunings = [1557 / srt, 1617 / srt, 1491 / srt, 1422 / srt, 1277 / srt, 1356 / srt, 1188 / srt, 1116 / srt];
var allpassFilterFrequencies = [225, 556, 441, 341];

// create the Freeverb

function Freeverb (audioContext) {
  var node = audioContext.createGain();
  node.channelCountMode = 'explicit';
  node.channelCount = 2;

  var output = audioContext.createGain();
  var merger = audioContext.createChannelMerger(2);
  var splitter = audioContext.createChannelSplitter(2);
  var highpass = audioContext.createBiquadFilter();
  highpass.type = 'highpass';
  highpass.frequency.value = 200;

  var wet = audioContext.createGain();
  var dry = audioContext.createGain();

  node.connect(dry);
  node.connect(wet);
  wet.connect(splitter);
  merger.connect(highpass);
  highpass.connect(output);
  dry.connect(output);

  var combFilters = [];
  var allpassFiltersL = [];
  var allpassFiltersR = [];
  var roomSize = 0.8;
  var dampening = 3000;

  // make the allpass filters on the right
  for (var l = 0; l < allpassFilterFrequencies.length; l++) {
    var allpassL = audioContext.createBiquadFilter();
    allpassL.type = 'allpass';
    allpassL.frequency.value = allpassFilterFrequencies[l];
    allpassFiltersL.push(allpassL);

    if (allpassFiltersL[l - 1]) {
      allpassFiltersL[l - 1].connect(allpassL);
    }
  }

  // make the allpass filters on the left
  for (var r = 0; r < allpassFilterFrequencies.length; r++) {
    var allpassR = audioContext.createBiquadFilter();
    allpassR.type = 'allpass';
    allpassR.frequency.value = allpassFilterFrequencies[r];
    allpassFiltersR.push(allpassR);

    if (allpassFiltersR[r - 1]) {
      allpassFiltersR[r - 1].connect(allpassR);
    }
  }

  allpassFiltersL[allpassFiltersL.length - 1].connect(merger, 0, 0);
  allpassFiltersR[allpassFiltersR.length - 1].connect(merger, 0, 1);

  // make the comb filters
  for (var c = 0; c < combFilterTunings.length; c++) {
    var lfpf = LowpassCombFilter(audioContext);
    lfpf.delayTime.value = combFilterTunings[c];
    if (c < combFilterTunings.length / 2) {
      splitter.connect(lfpf, 0);
      lfpf.connect(allpassFiltersL[0]);
    } else {
      splitter.connect(lfpf, 1);
      lfpf.connect(allpassFiltersR[0]);
    }
    combFilters.push(lfpf);
  }

  Object.defineProperties(node, {
    roomSize: {
      get: function () {
        return roomSize;
      },
      set: function (value) {
        roomSize = value;
        refreshFilters();
      }
    },
    dampening: {
      get: function () {
        return dampening;
      },

      set: function (value) {
        dampening = value;
        refreshFilters();
      }
    }
  });

  refreshFilters();

  node.connect = output.connect.bind(output);
  node.disconnect = output.disconnect.bind(output);
  node.wet = wet.gain;
  node.dry = dry.gain;

  // expose combFilters for direct automation
  node.combFilters = combFilters;

  return node;

  // scoped

  function refreshFilters () {
    for (var i = 0; i < combFilters.length; i++) {
      combFilters[i].resonance.value = roomSize;
      combFilters[i].dampening.value = dampening;
    }
  }
}

//
// Master Effects
// 0 values are modified at run time w/ volUp();
//

var superMasterGain = audioContext.createGain();
var masterFilterA = audioContext.createBiquadFilter();
var preSuperMasterGain = audioContext.createGain();


// delay

var delGain = audioContext.createGain();
delGain.gain.value = 0;
var mfilter = audioContext.createBiquadFilter();
mfilter.type = "highpass";
mfilter.frequency.value = 400;
mfilter.Q.value = 10;
var mdelay = audioContext.createDelay();
mdelay.delayTime.value = 0.2;
mdelay.connect(mfilter);
mfilter.connect(delGain);
delGain.connect(preSuperMasterGain);


// "master" gain

masterGain.gain.value = 0;
masterGain.connect(preSuperMasterGain);
masterGain.connect(mdelay);


// add slight low shelf attenuation

preSuperMasterGain.connect(masterFilterA);
preSuperMasterGain.gain.value = 1;

masterFilterA.type = "lowshelf";
masterFilterA.frequency.value = 250;
masterFilterA.gain.value = -7;


// master reverb via Freeverb

var mReverb = Freeverb(audioContext);
masterFilterA.connect(mReverb);

// KEEP ROOMSIZE UNDER 0.8 OR FIREFOX FREAKS OUT

mReverb.roomSize = 0.7;
mReverb.dampening = 4000;
mReverb.wet.value = 0.12;
mReverb.dry.value = 1;
mReverb.connect(superMasterGain);


// final output

superMasterGain.connect(audioContext.destination);
superMasterGain.gain.value = 0;

//
// BEGIN PLAYBACK CONTROLS
//


// keep track of time

var pauseTime = 0;
var pauseTimeStamp = 0;
var pauseTotal = 0;

function beginOrg() {

// begin organ loops at appropriate times

  organ1.start(startTime1);
  organ2.start(startTime2);
  organ3.start(startTime3);
  organ4.start(startTime4);
  organ5.start(startTime5);
  if("detune" in AudioBufferSourceNode) {
    organ5Up.start(startTime5);
  }


// track duration of loops

  dur1 = organ1.buffer.duration;
  dur2 = organ2.buffer.duration;
  dur3 = organ3.buffer.duration;
  dur4 = organ4.buffer.duration;
  dur5 = organ5.buffer.duration;
}

function beginLFO() {
// begin LFOs

	LFO1.start(del);
  LFO2.start(del);
}

function stopOrg() {

// stop organs (with 0.11s of advance notice)
// this destroys the AudioBufferSourceNodes

  var nowTime = audioContext.currentTime;
  organ1.stop(nowTime + 0.11);
  organ2.stop(nowTime + 0.11);
  organ3.stop(nowTime + 0.11);
  organ4.stop(nowTime + 0.11);
  organ5.stop(nowTime + 0.11);

  if("detune" in AudioBufferSourceNode) {
    organ5Up.stop(nowTime + 0.11);
  }
}

function tempBuff() {

  pauseTimeStamp = audioContext.currentTime;
  var nowTime = audioContext.currentTime;


  //totalElapsed is the total time spent playing music

  var totalElapsed = nowTime - pauseTotal;


  // the following will at *least* create an initial
  // starting delay of "del"
  // and it will include any remaining delay from startTimes

  newStart1 = startTime1 - totalElapsed;
  newStart1 = Math.max(del,newStart1);

  newStart2 = startTime2 - totalElapsed;
  newStart2 = Math.max(del,newStart2);

  newStart3 = startTime3 - totalElapsed;
  newStart3 = Math.max(del,newStart3);

  newStart4 = startTime4 - totalElapsed;
  newStart4 = Math.max(del,newStart4);

  newStart5 = startTime5 - totalElapsed;
  newStart5 = Math.max(del,newStart5);


// track how many times each loop has been played

  var timesPlayed1 = (totalElapsed - startTime1) / dur1;
  var timesPlayed2 = (totalElapsed - startTime2) / dur2;
  var timesPlayed3 = (totalElapsed - startTime3) / dur3;
  var timesPlayed4 = (totalElapsed - startTime4) / dur4;
  var timesPlayed5 = (totalElapsed - startTime5) / dur5;

  timesPlayed1 = timesPlayed1 - Math.trunc(timesPlayed1);
  timesPlayed2 = timesPlayed2 - Math.trunc(timesPlayed2);
  timesPlayed3 = timesPlayed3 - Math.trunc(timesPlayed3);
  timesPlayed4 = timesPlayed4 - Math.trunc(timesPlayed4);
  timesPlayed5 = timesPlayed5 - Math.trunc(timesPlayed5);


// make anything less than 0 into a 0
// (to prevent negative offsets)

  newOff1 = Math.max(0,timesPlayed1);
  newOff2 = Math.max(0,timesPlayed2);
  newOff3 = Math.max(0,timesPlayed3);
  newOff4 = Math.max(0,timesPlayed4);
  newOff5 = Math.max(0,timesPlayed5);

  newOff1 = newOff1 * dur1;
  newOff2 = newOff2 * dur2;
  newOff3 = newOff3 * dur3;
  newOff4 = newOff4 * dur4;
  newOff5 = newOff5 * dur5;
}


function reBuff() {

// calculate the total amount of time spent paused

  var nowTime = audioContext.currentTime;
  pauseTime = nowTime - pauseTimeStamp;
  pauseTotal = pauseTotal + pauseTime;


// create new AudioBufferSourceNodes...

  organ1 = audioContext.createBufferSource();
  organ2 = audioContext.createBufferSource();
  organ3 = audioContext.createBufferSource();
  organ4 = audioContext.createBufferSource();
  organ5 = audioContext.createBufferSource();
  if("detune" in AudioBufferSourceNode) {
    organ5Up = audioContext.createBufferSource();
  }

// ...but re-use the same audioBuffers

  organ1.buffer = temp1;
  organ2.buffer = temp2;
  organ3.buffer = temp3;
  organ4.buffer = temp4;
  organ5.buffer = temp5;
  if("detune" in AudioBufferSourceNode) {
    organ5Up.buffer = temp5;
  }


// connect the source nodes into the audio graph
// and apply playback-rate shift

  organ1.loop = true;
  organ2.loop = true;
  organ3.loop = true;
  organ4.loop = true;
  organ5.loop = true;
  if("detune" in AudioBufferSourceNode) {
    organ5Up.loop = true;
  }

  organ1.playbackRate.value = shift;
  organ2.playbackRate.value = shift;
  organ3.playbackRate.value = shift;
  organ4.playbackRate.value = shift;
  organ5.playbackRate.value = shift;
  if("detune" in AudioBufferSourceNode) {
    organ5Up.playbackRate.value = shift;
  }

  organ1.connect(filter1);
  organ2.connect(filter2);
  organ3.connect(filter3);
  organ4.connect(filter4);
  organ5.connect(filter5);
  if("detune" in AudioBufferSourceNode) {
  organ5Up.connect(volume5UpPre);
  }

// calculate correct start times
// (factoring in the original offset times)

  newStart1 = newStart1 + nowTime;
  newStart2 = newStart2 + nowTime;
  newStart3 = newStart3 + nowTime;
  newStart4 = newStart4 + nowTime;
  newStart5 = newStart5 + nowTime;

  organ1.start(newStart1, newOff1);
  organ2.start(newStart2, newOff2);
  organ3.start(newStart3, newOff3);
  organ4.start(newStart4, newOff4);
  organ5.start(newStart5, newOff5);
  if("detune" in AudioBufferSourceNode) {
    organ5Up.start(newStart5, newOff5);
  }
}

//
// toggle playback with "ORG" button
//

function volUp(nowTime1){
  delGain.gain.setTargetAtTime(0.2, nowTime1 + del, 0.12);
  masterGain.gain.setTargetAtTime(0.95, nowTime1 + del, 0.12);
  superMasterGain.gain.setTargetAtTime(0.95, nowTime1 + del, 0.12);
}

var audioInitiated = false;
var muted = false;

function playIt(del, shift, startTime1, startTime2, startTime3, startTime4, startTime5) {
  if (audioInitiated === false) {
    var nowTime1 = audioContext.currentTime;
    beginOrg();
    beginLFO();
    volUp(nowTime1);
    audioInitiated = true;
  } else {
    tog();
  }
}

function tog(del, shift) {
  if (muted === false) {
    var nowTime = audioContext.currentTime;
    delGain.gain.setTargetAtTime(0, nowTime + 0.05, 0.05);
    masterGain.gain.setTargetAtTime(0, nowTime + 0.05, 0.05);
    superMasterGain.gain.setTargetAtTime(0, nowTime + 0.05, 0.05);
    muted = true;
    tempBuff();
    stopOrg();
  } else {
    reBuff();
    var nowTime1 = audioContext.currentTime;
    volUp(nowTime1);
    muted = false;
  }
}


// pause playback when user leaves the page

    document.addEventListener("visibilitychange", function(del, shift) {
        if (audioInitiated === true && muted === false) {
          tog();}
        });


//
// if possible, register a service worker to cache assets for offline use;
// use the correct service worker cache for the device's audio sampleRate.
// if service workers are not available (Safari), use AppCache.
//

    if ('serviceWorker' in navigator && (typeof Cache !== 'undefined' && Cache.prototype.addAll) && ("fetch" in window) ) {

      if (audioContext.sampleRate === 44100) {
        navigator.serviceWorker.register('sw.js').then(function(registration) {
        }, function(err) {
        console.log('ServiceWorker sw registration failed: ', err);
        });
      } else {
        navigator.serviceWorker.register('sw48.js').then(function(registration) {
        }, function(err) {
        console.log('ServiceWorker sw48 registration failed: ', err);
        });
      }

    } else if ('applicationCache' in window) {
        if (audioContext.sampleRate === 44100) {
        // append appCache manifest location to <html> tag
         document.documentElement.manifest = "ios.appcache";

        // iframe hack to manage future appCache updates
        // var iframe = document.createElement('iframe');
        // iframe.style.display = 'none';
        // iframe.src = 'load-appcache.html'
        // document.body.appendChild(iframe);
        // console.log("iframe loaded for AppCache management");
        } else {
          // append appCache manifest location to <html> tag
           document.documentElement.manifest = "ios48.appcache";

          // iframe hack to manage future appCache updates
          // var iframe = document.createElement('iframe');
          // iframe.style.display = 'none';
          // iframe.src = 'load-appcache48.html'
          // document.body.appendChild(iframe);
          // console.log("iframe loaded for AppCache (48k) management");
        }

    } else {
      console.log("no caching method available");
    }


</script>

</body>
</html>
